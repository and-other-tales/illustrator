{% extends "base.html" %}

{% block title %}Style Configuration - Manuscript Illustrator{% endblock %}

{% block page_icon %}
<i class="bi bi-palette me-2"></i>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/manuscript/{{ manuscript_id }}">Manuscript</a></li>
        <li class="breadcrumb-item active">Style Configuration</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
        <div class="card shadow">
            <div class="card-header">
                <h3 class="mb-0 fw-bold d-flex align-items-center">
                    <span class="material-icons-outlined me-2">palette</span>
                    Configure Illustration Style
                </h3>
            </div>
            <div class="card-body">
                <form id="styleConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Image Provider Selection -->
                            <div class="mb-4">
                                <label for="imageProvider" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">smart_toy</span>
                                    Image Provider
                                </label>
                                <select class="form-select" id="imageProvider" name="image_provider" required>
                                    <option value="">Select Provider...</option>
                                    <option value="dalle">DALL-E</option>
                                    <option value="imagen4">Imagen 4</option>
                                    <option value="flux">Flux</option>
                                </select>
                                <div class="form-text">Choose the AI image generation provider</div>
                            </div>

                            <!-- Art Style -->
                            <div class="mb-4">
                                <label for="artStyle" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">brush</span>
                                    Art Style
                                </label>
                                <select class="form-select" id="artStyle" name="art_style" required>
                                    <option value="digital painting" selected>Digital Painting</option>
                                    <option value="watercolor">Watercolor</option>
                                    <option value="oil painting">Oil Painting</option>
                                    <option value="pencil sketch">Pencil Sketch</option>
                                    <option value="ink drawing">Ink Drawing</option>
                                    <option value="acrylic painting">Acrylic Painting</option>
                                    <option value="cartoon">Cartoon</option>
                                    <option value="anime">Anime</option>
                                    <option value="photorealistic">Photorealistic</option>
                                    <option value="impressionist">Impressionist</option>
                                    <option value="abstract">Abstract</option>
                                    <option value="minimalist">Minimalist</option>
                                </select>
                                <div class="form-text">Base artistic style for illustrations</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- Color Palette -->
                            <div class="mb-4">
                                <label for="colorPalette" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">color_lens</span>
                                    Color Palette
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="colorPalette"
                                       name="color_palette"
                                       placeholder="e.g., warm tones, muted colors, vibrant">
                                <div class="form-text">Optional: Specify color preferences</div>
                            </div>

                            <!-- Artistic Influences -->
                            <div class="mb-4">
                                <label for="artisticInfluences" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">auto_awesome</span>
                                    Artistic Influences
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="artisticInfluences"
                                       name="artistic_influences"
                                       placeholder="e.g., Van Gogh, Studio Ghibli, Art Nouveau">
                                <div class="form-text">Optional: Artists or art movements for inspiration</div>
                            </div>
                        </div>
                    </div>

                    <!-- Style Configuration File Path -->
                    <div class="mb-4">
                        <label for="styleConfigPath" class="form-label fw-semibold d-flex align-items-center">
                            <span class="material-icons-outlined me-2">description</span>
                            Style Configuration File
                        </label>
                        <input type="text"
                               class="form-control"
                               id="styleConfigPath"
                               name="style_config_path"
                               placeholder="Optional: Path to custom style configuration file">
                        <div class="form-text">Advanced: Load style settings from a configuration file</div>
                    </div>

                    <!-- Processing Options -->
                    <div class="mb-4">
                        <label for="maxEmotionalMoments" class="form-label fw-semibold d-flex align-items-center">
                            <span class="material-icons-outlined me-2">favorite</span>
                            Max Emotional Moments
                        </label>
                        <input type="number"
                               class="form-control"
                               id="maxEmotionalMoments"
                               name="max_emotional_moments"
                               value="10"
                               min="1"
                               max="20"
                               required>
                        <div class="form-text">Maximum number of key emotional moments to illustrate (1-20)</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row g-2 mt-4">
                        <div class="col-12 col-md-3">
                            <a href="/manuscript/{{ manuscript_id }}" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center">
                                <span class="material-icons-outlined me-2">arrow_back</span>
                                Back to Manuscript
                            </a>
                        </div>
                        <div class="col-12 col-md-3">
                            <button type="button" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center" onclick="saveStyleConfig()">
                                <span class="material-icons-outlined me-2">save</span>
                                Save Style
                            </button>
                        </div>
                        <div class="col-12 col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center" onclick="previewStyle()">
                                <span class="material-icons-outlined me-2">preview</span>
                                Preview Style
                            </button>
                        </div>
                        <div class="col-12 col-md-3">
                            <button type="submit" class="btn btn-primary w-100 d-flex align-items-center justify-content-center">
                                <span class="material-icons-outlined me-2">play_arrow</span>
                                Start Processing
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Style Preview Card -->
        <div class="card shadow mt-4" id="previewCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0 d-flex align-items-center">
                    <span class="material-icons-outlined me-2">preview</span>
                    Style Preview
                </h6>
            </div>
            <div class="card-body">
                <div id="previewContent" class="text-muted">
                    Select your style options and click "Preview Style" to see how your settings will affect the illustrations.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('styleConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const styleConfig = Object.fromEntries(formData.entries());

    // Convert string numbers to actual numbers
    styleConfig.max_emotional_moments = parseInt(styleConfig.max_emotional_moments);

    // Remove empty optional fields
    Object.keys(styleConfig).forEach(key => {
        if (!styleConfig[key] || styleConfig[key].trim() === '') {
            delete styleConfig[key];
        }
    });

    // Extract max_emotional_moments from styleConfig since it belongs at the top level
    const maxEmotionalMoments = styleConfig.max_emotional_moments || 10;
    delete styleConfig.max_emotional_moments;

    const requestData = {
        manuscript_id: "{{ manuscript_id }}",
        style_config: styleConfig,
        max_emotional_moments: maxEmotionalMoments
    };

    try {
        // Disable form while processing
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Starting...';

        const response = await fetch('/api/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            // Redirect to processing page
            window.location.href = `/manuscript/{{ manuscript_id }}/process?session_id=${result.session_id}`;
        } else {
            const error = await response.json();
            alert('Error starting processing: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        // Re-enable form
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Style preview function
async function previewStyle() {
    const formData = new FormData(document.getElementById('styleConfigForm'));
    const styleConfig = Object.fromEntries(formData.entries());

    const previewCard = document.getElementById('previewCard');
    const previewContent = document.getElementById('previewContent');

    // Validate required fields
    if (!styleConfig.image_provider) {
        showAlert('Please select an image provider to generate preview', 'warning');
        return;
    }

    // Show loading state
    previewContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generating preview...</span>
            </div>
            <p class="mt-2">Generating style preview image...</p>
        </div>
    `;
    previewCard.style.display = 'block';

    try {
        // Prepare request data
        const { max_emotional_moments, ...styleConfigOnly } = styleConfig;
        Object.keys(styleConfigOnly).forEach(key => {
            if (!styleConfigOnly[key] || styleConfigOnly[key].trim() === '') {
                delete styleConfigOnly[key];
            }
        });

        const requestData = {
            manuscript_id: "{{ manuscript_id }}",
            style_config: styleConfigOnly
        };

        const response = await fetch('/api/manuscripts/{{ manuscript_id }}/style/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();

            // Display image and style summary
            let preview = '<div class="text-center mb-3">';
            preview += `<img src="${result.image_url}" class="img-fluid rounded" style="max-width: 400px; max-height: 300px;" alt="Style Preview">`;
            preview += '</div>';

            preview += '<div class="row small">';
            if (result.style_summary.provider) {
                preview += `<div class="col-md-6 mb-1"><strong>Provider:</strong> ${result.style_summary.provider.toUpperCase()}</div>`;
            }
            if (result.style_summary.art_style) {
                preview += `<div class="col-md-6 mb-1"><strong>Art Style:</strong> ${result.style_summary.art_style}</div>`;
            }
            if (result.style_summary.color_palette) {
                preview += `<div class="col-md-6 mb-1"><strong>Colors:</strong> ${result.style_summary.color_palette}</div>`;
            }
            if (result.style_summary.artistic_influences) {
                preview += `<div class="col-md-6 mb-1"><strong>Influences:</strong> ${result.style_summary.artistic_influences}</div>`;
            }
            preview += '</div>';

            if (result.preview_prompt) {
                preview += `<div class="mt-2 small text-muted"><strong>Generated with prompt:</strong> ${result.preview_prompt}</div>`;
            }

            previewContent.innerHTML = preview;
        } else {
            const error = await response.json();
            previewContent.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error generating preview:</strong> ${error.detail || 'Unknown error'}
                </div>
            `;
        }
    } catch (error) {
        previewContent.innerHTML = `
            <div class="alert alert-danger">
                <strong>Network error:</strong> ${error.message}
            </div>
        `;
    }
}

// Save style configuration function
async function saveStyleConfig() {
    const formData = new FormData(document.getElementById('styleConfigForm'));
    const styleConfig = Object.fromEntries(formData.entries());

    // Convert string numbers to actual numbers
    styleConfig.max_emotional_moments = parseInt(styleConfig.max_emotional_moments);

    // Remove empty optional fields and the max_emotional_moments (it's not part of style config)
    const { max_emotional_moments, ...styleConfigOnly } = styleConfig;
    Object.keys(styleConfigOnly).forEach(key => {
        if (!styleConfigOnly[key] || styleConfigOnly[key].trim() === '') {
            delete styleConfigOnly[key];
        }
    });

    const requestData = {
        manuscript_id: "{{ manuscript_id }}",
        style_config: styleConfigOnly
    };

    try {
        const response = await fetch('/api/manuscripts/{{ manuscript_id }}/style', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            showAlert('Style configuration saved successfully!', 'success');
        } else {
            const error = await response.json();
            showAlert('Error saving style configuration: ' + (error.detail || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('Network error: ' + error.message, 'danger');
    }
}

// Load saved style configuration on page load
async function loadSavedStyleConfig() {
    try {
        const response = await fetch('/api/manuscripts/{{ manuscript_id }}/style');

        if (response.ok) {
            const result = await response.json();
            if (result.style_config) {
                populateForm(result.style_config);
            }
        }
    } catch (error) {
        console.error('Error loading saved style config:', error);
    }
}

// Populate form with saved configuration
function populateForm(styleConfig) {
    const form = document.getElementById('styleConfigForm');

    Object.keys(styleConfig).forEach(key => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
            input.value = styleConfig[key];
        }
    });
}

// Show alert function
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.card-body');
    container.appendChild(alertDiv);

    // Auto-remove alert after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Load saved configuration when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSavedStyleConfig();
});
</script>
{% endblock %}
