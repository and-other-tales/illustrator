{% extends "base.html" %}

{% block title %}Style Configuration - Manuscript Illustrator{% endblock %}

{% block page_icon %}
<i class="bi bi-palette me-2"></i>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/manuscript/{{ manuscript_id }}">Manuscript</a></li>
        <li class="breadcrumb-item active">Style Configuration</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
        <div class="card shadow">
            <div class="card-header">
                <h3 class="mb-0 fw-bold d-flex align-items-center">
                    <span class="material-icons-outlined me-2">palette</span>
                    Configure Illustration Style
                </h3>
            </div>
            <div class="card-body">
                <form id="styleConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Image Provider Selection -->
                            <div class="mb-4">
                                <label for="imageProvider" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">smart_toy</span>
                                    Image Provider
                                </label>
                                <select class="form-select" id="imageProvider" name="image_provider" required>
                                    <option value="">Select Provider...</option>
                                    <option value="dalle">DALL-E</option>
                                    <option value="imagen4">Imagen 4</option>
                                    <option value="flux">Flux</option>
                                    <option value="flux_dev_vertex">Flux Dev (Vertex AI)</option>
                                    <option value="huggingface">HuggingFace Endpoint</option>
                                    <option value="replicate">Replicate</option>
                                </select>
                                <div class="form-text">Choose the AI image generation provider</div>
                            </div>

                            <!-- Replicate Model Selection -->
                            <div class="mb-4" id="replicateModelGroup" style="display: none;">
                                <label for="replicateModel" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">hub</span>
                                    Replicate Model
                                </label>
                                <select class="form-select" id="replicateModel" name="replicate_model" disabled>
                                    <option value="">Select Model...</option>
                                    <option value="flux">Flux 1.1 Pro</option>
                                    <option value="imagen4">Imagen 4</option>
                                    <option value="seedream">Seedream 4</option>
                                </select>
                                <div class="form-text">Pick the Replicate-hosted text-to-image model</div>
                            </div>

                            <!-- HuggingFace Model Selection -->
                            <div class="mb-4" id="huggingfaceModelGroup" style="display: none;">
                                <label for="huggingfaceModelId" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">hub</span>
                                    HuggingFace Model
                                </label>
                                <input type="text" class="form-control" id="huggingfaceModelId" name="huggingface_model_id" placeholder="stabilityai/stable-diffusion-2-1" disabled>
                                <div class="form-text">Enter the HuggingFace text-to-image model in the format <code>author/model</code>.</div>
                                <div class="mt-3">
                                    <label for="huggingfaceProvider" class="form-label fw-semibold">Optional Provider Routing</label>
                                    <input type="text" class="form-control" id="huggingfaceProvider" name="huggingface_provider" placeholder="e.g. fal-ai or replicate" disabled>
                                    <div class="form-text">Set when using third-party providers via HuggingFace routing. Leave blank for default HuggingFace hosting.</div>
                                </div>
                            </div>

                            <!-- Flux Dev Vertex Configuration -->
                            <div class="mb-4" id="fluxDevVertexGroup" style="display: none;">
                                <label for="fluxDevVertexEndpointUrlLocal" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">cloud</span>
                                    Flux Dev Vertex Endpoint URL
                                </label>
                                <input type="text" class="form-control" id="fluxDevVertexEndpointUrlLocal" name="flux_dev_vertex_endpoint_url" placeholder="https://vertex.googleapis.com/v1/projects/.../endpoints/.../predict" disabled>
                                <div class="form-text">Enter the Google Vertex AI endpoint URL for your deployed Flux Dev model. This can also be set globally in the API credentials.</div>
                            </div>

                            <!-- Art Style -->
                            <div class="mb-4">
                                <label for="artStyle" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">brush</span>
                                    Art Style
                                </label>
                                <select class="form-select" id="artStyle" name="art_style" required>
                                    <option value="digital painting" selected>Digital Painting</option>
                                    <option value="watercolor">Watercolor</option>
                                    <option value="oil painting">Oil Painting</option>
                                    <option value="pencil sketch">Pencil Sketch</option>
                                    <option value="ink drawing">Ink Drawing</option>
                                    <option value="acrylic painting">Acrylic Painting</option>
                                    <option value="cartoon">Cartoon</option>
                                    <option value="anime">Anime</option>
                                    <option value="photorealistic">Photorealistic</option>
                                    <option value="impressionist">Impressionist</option>
                                    <option value="abstract">Abstract</option>
                                    <option value="minimalist">Minimalist</option>
                                </select>
                                <div class="form-text">Base artistic style for illustrations</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- Color Palette -->
                            <div class="mb-4">
                                <label for="colorPalette" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">color_lens</span>
                                    Color Palette
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="colorPalette"
                                       name="color_palette"
                                       placeholder="e.g., warm tones, muted colors, vibrant">
                                <div class="form-text">Optional: Specify color preferences</div>
                            </div>

                            <!-- Artistic Influences -->
                            <div class="mb-4">
                                <label for="artisticInfluences" class="form-label fw-semibold d-flex align-items-center">
                                    <span class="material-icons-outlined me-2">auto_awesome</span>
                                    Artistic Influences
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="artisticInfluences"
                                       name="artistic_influences"
                                       placeholder="e.g., Van Gogh, Studio Ghibli, Art Nouveau">
                                <div class="form-text">Optional: Artists or art movements for inspiration</div>
                            </div>
                        </div>
                    </div>

                    <!-- Style Configuration File Path -->
                    <div class="mb-4">
                        <label for="styleConfigPath" class="form-label fw-semibold d-flex align-items-center">
                            <span class="material-icons-outlined me-2">description</span>
                            Style Configuration File
                        </label>
                        <input type="text"
                               class="form-control"
                               id="styleConfigPath"
                               name="style_config_path"
                               placeholder="Optional: Path to custom style configuration file">
                        <div class="form-text">Advanced: Load style settings from a configuration file</div>
                    </div>

                    <!-- Processing Options -->
                    <div class="mb-4">
                        <label for="maxEmotionalMoments" class="form-label fw-semibold d-flex align-items-center">
                            <span class="material-icons-outlined me-2">favorite</span>
                            Max Emotional Moments
                        </label>
                        <input type="number"
                               class="form-control"
                               id="maxEmotionalMoments"
                               name="max_emotional_moments"
                               value="10"
                               min="1"
                               max="20"
                               required>
                        <div class="form-text">Maximum number of key emotional moments to illustrate (1-20)</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row g-2 mt-4 align-items-stretch">
                        <div class="col-12 col-md-3 d-grid">
                            <a href="/manuscript/{{ manuscript_id }}" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center style-action-btn">
                                <span class="material-icons-outlined me-2">arrow_back</span>
                                Back to Manuscript
                            </a>
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                            <button type="button" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center style-action-btn" onclick="saveStyleConfig()">
                                <span class="material-icons-outlined me-2">save</span>
                                Save Style
                            </button>
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                            <button type="button" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center style-action-btn" onclick="previewStyle()">
                                <span class="material-icons-outlined me-2">preview</span>
                                Preview Style
                            </button>
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                            <button type="submit" class="btn btn-primary w-100 d-flex align-items-center justify-content-center style-action-btn">
                                <span class="material-icons-outlined me-2">play_arrow</span>
                                Start Processing
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Style Preview Card -->
        <div class="card shadow mt-4" id="previewCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0 d-flex align-items-center">
                    <span class="material-icons-outlined me-2">preview</span>
                    Style Preview
                </h6>
            </div>
            <div class="card-body">
                <div id="previewExcerptContainer" class="mb-3" style="display: none;">
                    <label for="previewManuscriptExcerpt" class="form-label fw-semibold">Manuscript Excerpt (optional)</label>
                    <textarea class="form-control" id="previewManuscriptExcerpt" rows="4" placeholder="Paste a paragraph from your manuscript to generate a true-to-story preview..."></textarea>
                    <div class="form-text">The preview prompt will analyze this excerpt using the advanced prompt engineering pipeline before generating the image.</div>
                </div>
                <div id="previewContent" class="text-muted">
                    Select your style options and click "Preview Style" to see how your settings will affect the illustrations.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('styleConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const styleConfig = Object.fromEntries(formData.entries());

    try {
        normalizeStyleProvider(styleConfig);
    } catch (error) {
        showAlert(error.message, 'warning');
        return;
    }

    // Convert string numbers to actual numbers
    styleConfig.max_emotional_moments = parseInt(styleConfig.max_emotional_moments);

    // Remove empty optional fields
    Object.keys(styleConfig).forEach(key => {
        if (!styleConfig[key] || styleConfig[key].trim() === '') {
            delete styleConfig[key];
        }
    });

    // Extract max_emotional_moments from styleConfig since it belongs at the top level
    const maxEmotionalMoments = styleConfig.max_emotional_moments || 10;
    delete styleConfig.max_emotional_moments;

    const requestData = {
        manuscript_id: "{{ manuscript_id }}",
        style_config: styleConfig,
        max_emotional_moments: maxEmotionalMoments
    };

    try {
        // Disable form while processing
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Starting...';

        const response = await fetch('/api/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            // Redirect to processing page
            window.location.href = `/manuscript/{{ manuscript_id }}/process?session_id=${result.session_id}`;
        } else {
            const error = await response.json();
            alert('Error starting processing: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        // Re-enable form
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Style preview function
async function previewStyle() {
    const formData = new FormData(document.getElementById('styleConfigForm'));
    const styleConfig = Object.fromEntries(formData.entries());

    try {
        normalizeStyleProvider(styleConfig);
    } catch (error) {
        showAlert(error.message, 'warning');
        return;
    }

    const previewCard = document.getElementById('previewCard');
    const previewContent = document.getElementById('previewContent');
    const excerptContainer = document.getElementById('previewExcerptContainer');
    const excerptField = document.getElementById('previewManuscriptExcerpt');

    // Validate required fields
    if (!styleConfig.image_provider) {
        showAlert('Please select an image provider to generate preview', 'warning');
        return;
    }

    // Ensure preview card and excerpt input are visible
    previewCard.style.display = 'block';
    if (excerptContainer) {
        excerptContainer.style.display = 'block';
    }

    // On first open, prompt for excerpt input without making a request yet
    if (!previewCard.dataset.initialized) {
        previewContent.innerHTML = `
            <div class="alert alert-info mb-0">
                Paste a paragraph from your manuscript in the field above, then click <strong>Preview Style</strong> again to generate an excerpt-aware preview image.
            </div>
        `;
        previewCard.dataset.initialized = 'true';
        if (excerptField) {
            excerptField.focus();
        }
        return;
    }

    const manuscriptExcerpt = excerptField ? excerptField.value.trim() : '';

    // Show loading state
    const loadingMessage = manuscriptExcerpt
        ? 'Analyzing excerpt and generating preview image...'
        : 'Generating style preview image...';

    previewContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generating preview...</span>
            </div>
            <p class="mt-2">${loadingMessage}</p>
        </div>
    `;

    try {
        // Prepare request data
        const { max_emotional_moments, ...styleConfigOnly } = styleConfig;
        Object.keys(styleConfigOnly).forEach(key => {
            if (!styleConfigOnly[key] || styleConfigOnly[key].trim() === '') {
                delete styleConfigOnly[key];
            }
        });

        const requestData = {
            manuscript_id: "{{ manuscript_id }}",
            style_config: styleConfigOnly
        };

        if (manuscriptExcerpt) {
            requestData.manuscript_excerpt = manuscriptExcerpt;
        }

        const response = await fetch('/api/manuscripts/{{ manuscript_id }}/style/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();

            // Display image and style summary
            let preview = '<div class="text-center mb-3">';
            preview += `<img src="${result.image_url}" class="img-fluid rounded" style="max-width: 400px; max-height: 300px;" alt="Style Preview">`;
            preview += '</div>';

            preview += '<div class="row small">';
            if (result.style_summary.provider) {
                preview += `<div class="col-md-6 mb-1"><strong>Provider:</strong> ${result.style_summary.provider.toUpperCase()}</div>`;
            }
            if (result.style_summary.art_style) {
                preview += `<div class="col-md-6 mb-1"><strong>Art Style:</strong> ${result.style_summary.art_style}</div>`;
            }
            if (result.style_summary.color_palette) {
                preview += `<div class="col-md-6 mb-1"><strong>Colors:</strong> ${result.style_summary.color_palette}</div>`;
            }
            if (result.style_summary.artistic_influences) {
                preview += `<div class="col-md-6 mb-1"><strong>Influences:</strong> ${result.style_summary.artistic_influences}</div>`;
            }
            if (result.style_summary.huggingface_model_id) {
                preview += `<div class="col-md-6 mb-1"><strong>HuggingFace Model:</strong> ${result.style_summary.huggingface_model_id}</div>`;
            }
            if (result.style_summary.huggingface_provider) {
                preview += `<div class="col-md-6 mb-1"><strong>HF Provider:</strong> ${result.style_summary.huggingface_provider}</div>`;
            }
            preview += '</div>';

            if (result.style_summary.excerpt_preview) {
                preview += `<div class="mt-2 small"><strong>Excerpt analyzed:</strong> ${result.style_summary.excerpt_preview}</div>`;
            }

            if (result.preview_prompt) {
                preview += `<div class="mt-2 small text-muted"><strong>Generated with prompt:</strong> ${result.preview_prompt}</div>`;
            }

            previewContent.innerHTML = preview;
        } else {
            const error = await response.json();
            previewContent.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error generating preview:</strong> ${error.detail || 'Unknown error'}
                </div>
            `;
        }
    } catch (error) {
        previewContent.innerHTML = `
            <div class="alert alert-danger">
                <strong>Network error:</strong> ${error.message}
            </div>
        `;
    }
}

// Save style configuration function
async function saveStyleConfig() {
    const formData = new FormData(document.getElementById('styleConfigForm'));
    const styleConfig = Object.fromEntries(formData.entries());

    try {
        normalizeStyleProvider(styleConfig);
    } catch (error) {
        showAlert(error.message, 'warning');
        return;
    }

    // Convert string numbers to actual numbers
    styleConfig.max_emotional_moments = parseInt(styleConfig.max_emotional_moments);

    // Remove empty optional fields and the max_emotional_moments (it's not part of style config)
    const { max_emotional_moments, ...styleConfigOnly } = styleConfig;
    Object.keys(styleConfigOnly).forEach(key => {
        if (!styleConfigOnly[key] || styleConfigOnly[key].trim() === '') {
            delete styleConfigOnly[key];
        }
    });

    const requestData = {
        manuscript_id: "{{ manuscript_id }}",
        style_config: styleConfigOnly
    };

    try {
        const response = await fetch('/api/manuscripts/{{ manuscript_id }}/style', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            showAlert('Style configuration saved successfully!', 'success');
        } else {
            const error = await response.json();
            showAlert('Error saving style configuration: ' + (error.detail || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('Network error: ' + error.message, 'danger');
    }
}

// Load saved style configuration on page load
async function loadSavedStyleConfig() {
    try {
        const response = await fetch('/api/manuscripts/{{ manuscript_id }}/style');

        if (response.ok) {
            const result = await response.json();
            if (result.style_config) {
                populateForm(result.style_config);
            }
        }
    } catch (error) {
        console.error('Error loading saved style config:', error);
    }
}

// Populate form with saved configuration
function populateForm(styleConfig) {
    const form = document.getElementById('styleConfigForm');

    Object.keys(styleConfig).forEach(key => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
            input.value = styleConfig[key];
        }
    });

    const providerSelect = document.getElementById('imageProvider');
    const replicateSelect = document.getElementById('replicateModel');

    if (providerSelect && replicateSelect) {
        const providerValue = styleConfig.image_provider || '';

        if (providerValue === 'seedream') {
            providerSelect.value = 'replicate';
            replicateSelect.value = 'seedream';
        } else {
            providerSelect.value = providerValue;
            if (providerValue === 'replicate') {
                replicateSelect.value = providerValue;
            } else {
                replicateSelect.value = '';
            }
        }

        toggleProviderSpecificFields();
    }
}

// Show alert function
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.card-body');
    container.appendChild(alertDiv);

    // Auto-remove alert after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Load saved configuration when page loads
document.addEventListener('DOMContentLoaded', function() {
    const providerSelect = document.getElementById('imageProvider');
    if (providerSelect) {
        providerSelect.addEventListener('change', toggleProviderSpecificFields);
        toggleProviderSpecificFields();
    }

    loadSavedStyleConfig();
});

function toggleProviderSpecificFields() {
    const providerSelect = document.getElementById('imageProvider');
    const replicateGroup = document.getElementById('replicateModelGroup');
    const replicateSelect = document.getElementById('replicateModel');
    const huggingfaceGroup = document.getElementById('huggingfaceModelGroup');
    const huggingfaceModelInput = document.getElementById('huggingfaceModelId');
    const huggingfaceProviderInput = document.getElementById('huggingfaceProvider');
    const fluxDevVertexGroup = document.getElementById('fluxDevVertexGroup');
    const fluxDevVertexInput = document.getElementById('fluxDevVertexEndpointUrlLocal');

    if (!providerSelect || !replicateGroup || !replicateSelect || !huggingfaceGroup || !huggingfaceModelInput || !huggingfaceProviderInput || !fluxDevVertexGroup || !fluxDevVertexInput) {
        return;
    }

    const providerValue = providerSelect.value;
    const isReplicate = providerValue === 'replicate';
    replicateGroup.style.display = isReplicate ? 'block' : 'none';
    replicateSelect.disabled = !isReplicate;

    if (!isReplicate) {
        replicateSelect.value = '';
    } else if (!replicateSelect.value) {
        replicateSelect.value = 'flux';
    }

    const isHuggingFace = providerValue === 'huggingface';
    huggingfaceGroup.style.display = isHuggingFace ? 'block' : 'none';
    huggingfaceModelInput.disabled = !isHuggingFace;
    huggingfaceProviderInput.disabled = !isHuggingFace;

    const isFluxDevVertex = providerValue === 'flux_dev_vertex';
    fluxDevVertexGroup.style.display = isFluxDevVertex ? 'block' : 'none';
    fluxDevVertexInput.disabled = !isFluxDevVertex;

    if (!isFluxDevVertex) {
        fluxDevVertexInput.value = '';
    }
}

function normalizeStyleProvider(styleConfig) {
    if (!styleConfig) {
        return;
    }

    const provider = styleConfig.image_provider;
    const replicateModel = styleConfig.replicate_model;

    if (provider === 'replicate') {
        if (!replicateModel) {
            throw new Error('Please choose a Replicate model before continuing.');
        }
        styleConfig.image_provider = replicateModel;
    }

    if (provider === 'huggingface') {
        const modelField = document.getElementById('huggingfaceModelId');
        const modelId = (styleConfig.huggingface_model_id || '').trim();
        if (!modelId) {
            throw new Error('Please provide a HuggingFace model identifier (e.g. `stabilityai/stable-diffusion-2-1`).');
        }
        styleConfig.huggingface_model_id = modelId;

        if (modelField) {
            modelField.value = modelId;
        }

        const providerField = document.getElementById('huggingfaceProvider');
        if (providerField && styleConfig.huggingface_provider) {
            styleConfig.huggingface_provider = styleConfig.huggingface_provider.trim();
        }
    } else {
        delete styleConfig.huggingface_model_id;
        delete styleConfig.huggingface_provider;
    }

    if (provider === 'flux_dev_vertex') {
        const endpointField = document.getElementById('fluxDevVertexEndpointUrlLocal');
        const endpointUrl = (styleConfig.flux_dev_vertex_endpoint_url || '').trim();
        if (endpointUrl && endpointField) {
            endpointField.value = endpointUrl;
            styleConfig.flux_dev_vertex_endpoint_url = endpointUrl;
        }
    } else {
        delete styleConfig.flux_dev_vertex_endpoint_url;
    }

    delete styleConfig.replicate_model;
}
</script>
{% endblock %}
