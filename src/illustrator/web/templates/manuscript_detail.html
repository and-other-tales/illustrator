{% extends "base.html" %}

{% block title %}Manuscript Details - Manuscript Illustrator{% endblock %}

{% block page_icon %}
<i class="bi bi-book me-2"></i>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">Manuscript</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Manuscript Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-gradient text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="mb-1" id="manuscriptTitle">Loading...</h3>
                        <p class="mb-0 opacity-75" id="manuscriptAuthor">By Unknown Author</p>
                    </div>
                    <div>
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editManuscript()">
                                    <i class="bi bi-pencil me-2"></i>Edit Details
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportManuscript()">
                                    <i class="bi bi-download me-2"></i>Export
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteManuscript()">
                                    <i class="bi bi-trash me-2"></i>Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="d-flex gap-3 mb-3">
                            <span class="badge bg-primary-subtle text-primary" id="genreBadge">
                                <i class="bi bi-tag me-1"></i>Genre
                            </span>
                            <span class="badge bg-success-subtle text-success" id="statusBadge">
                                <i class="bi bi-check-circle me-1"></i>Draft
                            </span>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 mb-0 text-primary" id="totalChapters">0</div>
                                <small class="text-muted">Chapters</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0 text-success" id="totalWords">0</div>
                                <small class="text-muted">Words</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0 text-info" id="totalImages">0</div>
                                <small class="text-muted">Images</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="processManuscript()">
                                <i class="bi bi-magic me-2"></i>Generate Illustrations
                            </button>
                            <button class="btn btn-outline-primary" onclick="configureStyle()">
                                <i class="bi bi-palette me-2"></i>Configure Style
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chapters Section -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="material-icons-outlined me-2">menu_book</i>Chapters
                </h5>
                <button class="btn btn-success btn-sm" onclick="addNewChapter()">
                    <i class="bi bi-plus-circle me-1"></i>Add Chapter
                </button>
            </div>
            <div class="card-body">
                <!-- Chapters will be loaded here -->
                <div id="chaptersContainer">
                    <div class="text-center py-5" id="loadingChapters">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading chapters...</p>
                    </div>
                </div>

                <!-- Empty state -->
                <div id="noChaptersMessage" class="text-center py-5" style="display: none;">
                    <div class="text-muted">
                        <i class="bi bi-book fs-1"></i>
                        <h5 class="mt-3">No chapters yet</h5>
                        <p>Start by adding your first chapter to this manuscript.</p>
                        <button class="btn btn-primary" onclick="addNewChapter()">
                            <i class="bi bi-plus-circle me-2"></i>Add First Chapter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chapter Card Template -->
<template id="chapterTemplate">
    <div class="chapter-card mb-3">
        <div class="card border-start border-primary border-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-3 chapter-number">1</span>
                            <h6 class="mb-0 chapter-title">Chapter Title</h6>
                        </div>
                        <div class="row small text-muted">
                            <div class="col-sm-4">
                                <i class="bi bi-file-text me-1"></i>
                                <span class="word-count">0</span> words
                            </div>
                            <div class="col-sm-4">
                                <i class="bi bi-image me-1"></i>
                                <span class="image-count">0</span> images
                            </div>
                            <div class="col-sm-4">
                                <span class="badge bg-light text-dark status-badge">Draft</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex gap-1 justify-content-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="generateChapterHeaders(this)" title="Chapter Headers">
                                <i class="material-icons-outlined">palette</i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="editChapter(this)" title="Edit Chapter">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="analyzeChapter(this)" title="Analyze Chapter">
                                <i class="bi bi-search"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteChapter(this)" title="Delete Chapter">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
let currentManuscriptId = '{{ manuscript_id }}';
let manuscriptData = null;
let chapters = [];

document.addEventListener('DOMContentLoaded', function() {
    if (currentManuscriptId) {
        loadManuscriptDetails();
    }
});

async function loadManuscriptDetails() {
    try {
        showLoadingOverlay('Loading manuscript details...');

        // Load manuscript metadata
        const manuscriptResponse = await fetch(`/api/manuscripts/${currentManuscriptId}`);
        if (!manuscriptResponse.ok) {
            throw new Error('Failed to load manuscript');
        }
        manuscriptData = await manuscriptResponse.json();

        // Load chapters
        const chaptersResponse = await fetch(`/api/chapters/${currentManuscriptId}`);
        if (!chaptersResponse.ok) {
            throw new Error('Failed to load chapters');
        }
        chapters = await chaptersResponse.json();

        // Update UI
        updateManuscriptHeader();
        displayChapters();

        hideLoadingOverlay();

    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to load manuscript: ' + error.message);
    }
}

function updateManuscriptHeader() {
    document.getElementById('manuscriptTitle').textContent = manuscriptData.metadata.title;
    document.getElementById('manuscriptAuthor').textContent = `By ${manuscriptData.metadata.author || 'Unknown Author'}`;

    if (manuscriptData.metadata.genre) {
        document.getElementById('genreBadge').innerHTML = `<i class="bi bi-tag me-1"></i>${manuscriptData.metadata.genre}`;
    }

    document.getElementById('totalChapters').textContent = chapters.length;
    document.getElementById('totalWords').textContent = manuscriptData.chapters.reduce((total, ch) => total + (ch.word_count || 0), 0).toLocaleString();
    document.getElementById('totalImages').textContent = manuscriptData.total_images || 0;
}

function displayChapters() {
    const container = document.getElementById('chaptersContainer');
    const template = document.getElementById('chapterTemplate');
    const loadingMessage = document.getElementById('loadingChapters');
    const noChaptersMessage = document.getElementById('noChaptersMessage');

    // Clear loading
    loadingMessage.style.display = 'none';

    if (chapters.length === 0) {
        noChaptersMessage.style.display = 'block';
        return;
    }

    container.innerHTML = '';

    chapters.forEach(chapterResponse => {
        const chapter = chapterResponse.chapter;
        const chapterElement = template.content.cloneNode(true);

        chapterElement.querySelector('.chapter-number').textContent = chapter.number;
        chapterElement.querySelector('.chapter-title').textContent = chapter.title;
        chapterElement.querySelector('.word-count').textContent = (chapter.word_count || 0).toLocaleString();
        chapterElement.querySelector('.image-count').textContent = chapterResponse.images_generated || 0;
        chapterElement.querySelector('.status-badge').textContent = chapterResponse.processing_status || 'Draft';

        // Store chapter ID for actions
        const card = chapterElement.querySelector('.chapter-card');
        card.setAttribute('data-chapter-id', chapterResponse.id);

        container.appendChild(chapterElement);
    });
}

function addNewChapter() {
    window.location.href = `/manuscript/${currentManuscriptId}/chapter/new`;
}

function editChapter(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    window.location.href = `/chapter/${chapterId}/edit`;
}

function generateChapterHeaders(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    window.location.href = `/chapter/${chapterId}/headers`;
}

function analyzeChapter(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    // This would trigger chapter analysis
    showInfo('Chapter analysis feature coming soon!');
}

async function deleteChapter(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    const chapterTitle = button.closest('.chapter-card').querySelector('.chapter-title').textContent;

    if (!confirm(`Delete chapter "${chapterTitle}"? This action cannot be undone.`)) {
        return;
    }

    try {
        showLoadingOverlay('Deleting chapter...');

        const response = await fetch(`/api/chapters/${chapterId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete chapter');
        }

        hideLoadingOverlay();
        showSuccess('Chapter deleted successfully');
        loadManuscriptDetails(); // Reload to update

    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to delete chapter: ' + error.message);
    }
}

function editManuscript() {
    window.location.href = `/manuscript/${currentManuscriptId}/edit`;
}

function configureStyle() {
    window.location.href = `/manuscript/${currentManuscriptId}/style`;
}

function processManuscript() {
    window.location.href = `/manuscript/${currentManuscriptId}/process`;
}

function exportManuscript() {
    showInfo('Export feature coming soon!');
}

async function deleteManuscript() {
    if (!confirm('Delete this entire manuscript? This action cannot be undone.')) {
        return;
    }

    try {
        showLoadingOverlay('Deleting manuscript...');

        const response = await fetch(`/api/manuscripts/${currentManuscriptId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete manuscript');
        }

        hideLoadingOverlay();
        showSuccess('Manuscript deleted successfully');
        setTimeout(() => {
            window.location.href = '/';
        }, 1500);

    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to delete manuscript: ' + error.message);
    }
}
</script>
{% endblock %}