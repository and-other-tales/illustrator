{% extends "base.html" %}

{% block title %}{{ manuscript_title | default('Manuscript Details') }} - Manuscript Illustrator{% endblock %}

{% block page_icon %}
<i class="bi bi-book me-2"></i>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Manuscript Header -->
<div class="row mb-4">
    <div class="col-lg-10 offset-lg-1 col-xl-8 offset-xl-2">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-gradient text-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h3 class="mb-1" id="manuscriptTitle">Loading...</h3>
                        <p class="mb-0 opacity-75" id="manuscriptAuthor">By Unknown Author</p>
                    </div>
                    <div>
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editManuscript()">
                                    <i class="bi bi-pencil me-2"></i>Edit Details
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportManuscript()">
                                    <i class="bi bi-download me-2"></i>Export
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteManuscript()">
                                    <i class="bi bi-trash me-2"></i>Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="d-flex gap-3 mb-3">
                            <span class="badge bg-primary-subtle text-primary" id="genreBadge">
                                <i class="bi bi-tag me-1"></i>Genre
                            </span>
                            <span class="badge bg-success-subtle text-success" id="statusBadge">
                                <i class="bi bi-check-circle me-1"></i>Draft
                            </span>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 mb-0 text-primary" id="totalChapters">0</div>
                                <small class="text-muted">Chapters</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0 text-success" id="totalWords">0</div>
                                <small class="text-muted">Words</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0 text-info" id="totalImages">0</div>
                                <small class="text-muted">Images</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="processBtn" onclick="processManuscript()">
                                <i class="bi bi-magic me-2" id="processIcon"></i><span id="processBtnText">Generate Illustrations</span>
                            </button>
                            <button class="btn btn-surface-light text-primary style-action-btn" onclick="configureStyle()">
                                <i class="bi bi-palette me-2"></i>Configure Style
                            </button>
                            <button class="btn btn-surface-light text-secondary position-relative style-action-btn" id="viewGalleryBtn" onclick="viewGallery()" style="display: none;">
                                <i class="bi bi-images me-2"></i>View Gallery
                                <span class="badge bg-secondary-subtle text-secondary border position-absolute top-50 translate-middle-y" id="galleryImageCountBadge" style="right: 16px; display: none;">
                                    0
                                </span>
                            </button>
                            <button class="btn btn-outline-danger" id="resetImagesBtn" onclick="resetManuscriptImages()" disabled>
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Illustrations
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chapters Section -->
<div class="row">
    <div class="col-lg-10 offset-lg-1 col-xl-8 offset-xl-2">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0 fw-bold">
                    <i class="bi bi-book me-2"></i>Chapters
                </h3>
                <button class="btn btn-success btn-sm" onclick="addNewChapter()">
                    <i class="bi bi-plus-circle me-1"></i>Add Chapter
                </button>
            </div>
            <div class="card-body">
                <!-- Chapters will be loaded here -->
                <div id="chaptersContainer">
                    <div class="text-center py-5" id="loadingChapters">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading chapters...</p>
                    </div>
                </div>

                <!-- Empty state -->
                <div id="noChaptersMessage" class="text-center py-5" style="display: none;">
                    <div class="text-muted">
                        <i class="bi bi-book fs-1"></i>
                        <h5 class="mt-3">No chapters yet</h5>
                        <p>Start by adding your first chapter to this manuscript.</p>
                        <button class="btn btn-primary" onclick="addNewChapter()">
                            <i class="bi bi-plus-circle me-2"></i>Add First Chapter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chapter Card Template -->
<template id="chapterTemplate">
    <div class="chapter-card mb-3">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle me-3 chapter-number fw-semibold px-3 py-2">1</span>
                            <h6 class="mb-0 chapter-title fw-semibold">Chapter Title</h6>
                        </div>
                        <div class="row small text-muted">
                            <div class="col-sm-4">
                                <i class="bi bi-file-text me-1"></i>
                                <span class="word-count">0</span> words
                            </div>
                            <div class="col-sm-4">
                                <i class="bi bi-image me-1"></i>
                                <span class="image-count">0</span> images
                            </div>
                            <div class="col-sm-4">
                                <span class="badge bg-light text-dark status-badge">Draft</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex gap-1 justify-content-end align-items-center">
                            <button class="btn btn-sm btn-outline-secondary d-flex align-items-center justify-content-center view-images-btn" onclick="viewChapterImages(this)" title="View Images" style="width: 32px; height: 32px; display: none;">
                                <i class="bi bi-images"></i>
                            </button>
                            <button class="btn btn-sm btn-light border d-flex align-items-center justify-content-center" onclick="generateChapterHeaders(this)" title="Chapter Headers" style="width: 32px; height: 32px;">
                                <i class="bi bi-palette"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center" onclick="editChapter(this)" title="Edit Chapter" style="width: 32px; height: 32px;">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success d-flex align-items-center justify-content-center" onclick="analyzeChapter(this)" title="Analyze Chapter" style="width: 32px; height: 32px;">
                                <i class="bi bi-search"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center" onclick="deleteChapter(this)" title="Delete Chapter" style="width: 32px; height: 32px;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Chapter Analysis Modal -->
<div class="modal fade" id="chapterAnalysisModal" tabindex="-1" aria-labelledby="chapterAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title fw-bold" id="chapterAnalysisModalLabel">
                    <i class="bi bi-search me-2"></i>Chapter Analysis
                </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="analysisLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Analyzing chapter...</span>
                    </div>
                    <p class="mt-3 text-muted">Performing comprehensive chapter analysis...</p>
                </div>

                <!-- Analysis Results -->
                <div id="analysisResults" style="display: none;">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">Analysis Summary</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="h4 mb-0" id="emotionalMomentsCount">0</div>
                                            <small class="text-muted">Emotional Moments</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h4 mb-0" id="scenesCount">0</div>
                                            <small class="text-muted">Scenes</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <span class="badge bg-primary me-2" id="illustrationReadiness">Moderate</span>
                                        <span class="badge bg-info" id="narrativeComplexity">Medium</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">Chapter Statistics</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="h5 mb-0" id="wordCount">0</div>
                                            <small class="text-muted">Words</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 mb-0" id="emotionalDensity">0</div>
                                            <small class="text-muted">Emotional Density</small>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <div class="h6 mb-0" id="paragraphCount">0</div>
                                            <small class="text-muted">Paragraphs</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h6 mb-0" id="avgSentenceLength">0</div>
                                            <small class="text-muted">Avg Sentence Length</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Tabs -->
                    <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="emotional-tab" data-bs-toggle="tab" data-bs-target="#emotional" type="button" role="tab">
                                <i class="bi bi-heart me-1"></i>Emotional Moments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="scenes-tab" data-bs-toggle="tab" data-bs-target="#scenes" type="button" role="tab">
                                <i class="bi bi-camera-video me-1"></i>Scenes
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="narrative-tab" data-bs-toggle="tab" data-bs-target="#narrative" type="button" role="tab">
                                <i class="bi bi-graph-up me-1"></i>Narrative Structure
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="illustration-tab" data-bs-toggle="tab" data-bs-target="#illustration" type="button" role="tab">
                                <i class="bi bi-palette me-1"></i>Illustration Potential
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="analysisTabContent">
                        <!-- Emotional Moments Tab -->
                        <div class="tab-pane fade show active" id="emotional" role="tabpanel">
                            <div class="mt-3">
                                <h6>Key Emotional Moments</h6>
                                <div id="emotionalMomentsList"></div>
                            </div>
                        </div>

                        <!-- Scenes Tab -->
                        <div class="tab-pane fade" id="scenes" role="tabpanel">
                            <div class="mt-3">
                                <h6>Scene Breakdown</h6>
                                <div id="scenesList"></div>
                            </div>
                        </div>

                        <!-- Narrative Structure Tab -->
                        <div class="tab-pane fade" id="narrative" role="tabpanel">
                            <div class="mt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Tension Points</h6>
                                        <div id="tensionPointsList"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Character Arcs</h6>
                                        <div id="characterArcsList"></div>
                                        <h6 class="mt-3">Themes</h6>
                                        <div id="themesList"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Illustration Potential Tab -->
                        <div class="tab-pane fade" id="illustration" role="tabpanel">
                            <div class="mt-3">
                                <h6>Top Illustration Opportunities</h6>
                                <div id="illustrationMomentsList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="analysisError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="exportAnalysisBtn" onclick="exportAnalysis()" style="display: none;">
                    <i class="bi bi-download me-1"></i>Export Analysis
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentManuscriptId = '{{ manuscript_id }}';
let manuscriptData = null;
let chapters = [];
let activeSession = null;

document.addEventListener('DOMContentLoaded', function() {
    if (currentManuscriptId) {
        loadManuscriptDetails();
        checkProcessingStatus();
    }
});

async function loadManuscriptDetails() {
    try {
        showLoadingOverlay('Loading manuscript details...');

        // Load manuscript metadata and chapters in parallel
        const [manuscriptResponse, chaptersResponse] = await Promise.all([
            fetch(`/api/manuscripts/${currentManuscriptId}`),
            fetch(`/api/chapters/${currentManuscriptId}`)
        ]);

        if (!manuscriptResponse.ok) {
            throw new Error('Failed to load manuscript');
        }
        if (!chaptersResponse.ok) {
            throw new Error('Failed to load chapters');
        }

        [manuscriptData, chapters] = await Promise.all([
            manuscriptResponse.json(),
            chaptersResponse.json()
        ]);

        // Update UI
        updateManuscriptHeader();
        displayChapters();

        hideLoadingOverlay();

    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to load manuscript: ' + error.message);
    }
}

function updateManuscriptHeader() {
    const title = manuscriptData.metadata.title;

    // Update page title
    document.title = `${title} - Manuscript Illustrator`;

    // Update header content
    document.getElementById('manuscriptTitle').textContent = title;
    document.getElementById('manuscriptAuthor').textContent = `By ${manuscriptData.metadata.author || 'Unknown Author'}`;

    if (manuscriptData.metadata.genre) {
        document.getElementById('genreBadge').innerHTML = `<i class="bi bi-tag me-1"></i>${manuscriptData.metadata.genre}`;
    }

    document.getElementById('totalChapters').textContent = chapters.length;
    document.getElementById('totalWords').textContent = manuscriptData.chapters.reduce((total, ch) => total + (ch.word_count || 0), 0).toLocaleString();

    const totalImages = manuscriptData.total_images || 0;
    document.getElementById('totalImages').textContent = totalImages;
    updateGalleryButton(totalImages);
}

function displayChapters() {
    const container = document.getElementById('chaptersContainer');
    const template = document.getElementById('chapterTemplate');
    const loadingMessage = document.getElementById('loadingChapters');
    const noChaptersMessage = document.getElementById('noChaptersMessage');

    // Clear loading
    loadingMessage.style.display = 'none';

    if (chapters.length === 0) {
        noChaptersMessage.style.display = 'block';
        return;
    }

    container.innerHTML = '';

    chapters.forEach(chapterResponse => {
        const chapter = chapterResponse.chapter;
        const chapterElement = template.content.cloneNode(true);

        chapterElement.querySelector('.chapter-number').textContent = chapter.number;
        chapterElement.querySelector('.chapter-title').textContent = chapter.title;
        chapterElement.querySelector('.word-count').textContent = (chapter.word_count || 0).toLocaleString();
        chapterElement.querySelector('.image-count').textContent = chapterResponse.images_generated || 0;
        chapterElement.querySelector('.status-badge').textContent = chapterResponse.processing_status || 'Draft';

        // Store chapter ID for actions
        const card = chapterElement.querySelector('.chapter-card');
        card.setAttribute('data-chapter-id', chapterResponse.id);
        card.setAttribute('data-chapter-number', chapter.number);

        // Reveal image controls when available
        const viewImagesButton = chapterElement.querySelector('.view-images-btn');
        if (viewImagesButton) {
            if (chapterResponse.images_generated && chapterResponse.images_generated > 0) {
                viewImagesButton.style.display = 'flex';
                viewImagesButton.setAttribute('data-images-count', chapterResponse.images_generated);
                viewImagesButton.setAttribute('title', `View ${chapterResponse.images_generated} generated ${chapterResponse.images_generated === 1 ? 'image' : 'images'}`);
                viewImagesButton.setAttribute('aria-label', `View ${chapterResponse.images_generated} images`);
            } else {
                viewImagesButton.style.display = 'none';
                viewImagesButton.removeAttribute('data-images-count');
                viewImagesButton.removeAttribute('title');
                viewImagesButton.removeAttribute('aria-label');
            }
        }

        container.appendChild(chapterElement);
    });
}

function updateGalleryButton(totalImages) {
    const button = document.getElementById('viewGalleryBtn');
    const badge = document.getElementById('galleryImageCountBadge');
    const resetButton = document.getElementById('resetImagesBtn');

    if (!button) {
        return;
    }

    button.style.display = 'block';
    button.setAttribute('data-images-count', totalImages);
    button.title = totalImages > 0
        ? `Open gallery with ${totalImages} generated ${totalImages === 1 ? 'image' : 'images'}`
        : 'Open gallery (no images yet)';

    if (badge) {
        if (totalImages > 0) {
            badge.textContent = totalImages;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    if (resetButton) {
        resetButton.disabled = totalImages === 0;
        resetButton.setAttribute('aria-disabled', totalImages === 0 ? 'true' : 'false');
        resetButton.setAttribute('data-images-count', totalImages);
        resetButton.title = totalImages > 0
            ? `Delete all ${totalImages} generated ${totalImages === 1 ? 'image' : 'images'}`
            : 'No generated images to remove yet';
        resetButton.style.display = 'block';
    }
}

function viewGallery() {
    if (!currentManuscriptId) {
        return;
    }
    window.location.href = `/manuscript/${currentManuscriptId}/gallery`;
}

async function resetManuscriptImages() {
    if (!currentManuscriptId) {
        return;
    }

    const resetButton = document.getElementById('resetImagesBtn');
    const totalImages = resetButton ? parseInt(resetButton.getAttribute('data-images-count') || '0', 10) : 0;
    const confirmationMessage = totalImages > 0
        ? `This will permanently delete all ${totalImages} generated ${totalImages === 1 ? 'image' : 'images'} for this manuscript. Continue?`
        : 'This will remove any generated illustrations for this manuscript. Continue?';

    if (!window.confirm(confirmationMessage)) {
        return;
    }

    try {
        if (resetButton) {
            resetButton.disabled = true;
            resetButton.setAttribute('aria-disabled', 'true');
        }

        showLoadingOverlay('Removing generated illustrations...');

        const response = await fetch(`/api/manuscripts/${currentManuscriptId}/images`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            let errorDetail = 'Failed to delete images';
            try {
                const errorBody = await response.json();
                errorDetail = errorBody.detail || errorDetail;
            } catch (parseError) {
                // Ignore JSON parsing errors and use default message
            }
            throw new Error(errorDetail);
        }

        const result = await response.json().catch(() => ({}));

        hideLoadingOverlay();
        showSuccess(result.message || 'All generated illustrations have been removed.');

        // Refresh manuscript data to update counts and buttons
        await loadManuscriptDetails();
    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to reset illustrations: ' + error.message);

        if (resetButton) {
            const remainingImages = parseInt(resetButton.getAttribute('data-images-count') || '0', 10);
            const hasImages = remainingImages > 0;
            resetButton.disabled = !hasImages;
            resetButton.setAttribute('aria-disabled', hasImages ? 'false' : 'true');
        }
    }
}

function viewChapterImages(button) {
    const card = button.closest('.chapter-card');
    if (!card) {
        viewGallery();
        return;
    }

    const chapterNumber = card.getAttribute('data-chapter-number');
    if (!chapterNumber) {
        viewGallery();
        return;
    }

    const galleryUrl = new URL(window.location.origin + `/manuscript/${currentManuscriptId}/gallery`);
    const chapterLabel = `Chapter ${chapterNumber}`;
    galleryUrl.searchParams.set('chapter', chapterLabel);

    const imagesCount = button.getAttribute('data-images-count');
    if (imagesCount) {
        galleryUrl.searchParams.set('images', imagesCount);
    }

    window.location.href = galleryUrl.pathname + galleryUrl.search;
}

function addNewChapter() {
    window.location.href = `/manuscript/${currentManuscriptId}/chapter/new`;
}

function editChapter(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    window.location.href = `/chapter/${chapterId}/edit`;
}

function generateChapterHeaders(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    window.location.href = `/chapter/${chapterId}/headers`;
}

async function analyzeChapter(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    const chapterTitle = button.closest('.chapter-card').querySelector('.chapter-title').textContent;

    // Update modal title
    document.getElementById('chapterAnalysisModalLabel').innerHTML = `<i class="bi bi-search me-2"></i>Chapter Analysis: ${chapterTitle}`;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('chapterAnalysisModal'));
    modal.show();

    // Reset modal state
    document.getElementById('analysisLoading').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'none';
    document.getElementById('analysisError').style.display = 'none';
    document.getElementById('exportAnalysisBtn').style.display = 'none';

    try {
        const response = await fetch(`/api/chapters/${chapterId}/analyze`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to analyze chapter');
        }

        const analysisData = await response.json();

        if (analysisData.success) {
            displayAnalysisResults(analysisData.analysis);
            document.getElementById('exportAnalysisBtn').style.display = 'inline-block';
        } else {
            throw new Error('Analysis failed');
        }

    } catch (error) {
        document.getElementById('analysisLoading').style.display = 'none';
        document.getElementById('analysisError').style.display = 'block';
        document.getElementById('analysisError').textContent = `Failed to analyze chapter: ${error.message}`;
    }
}

function displayAnalysisResults(analysis) {
    // Hide loading, show results
    document.getElementById('analysisLoading').style.display = 'none';
    document.getElementById('analysisResults').style.display = 'block';

    // Update summary cards
    document.getElementById('emotionalMomentsCount').textContent = analysis.emotional_analysis.total_moments;
    document.getElementById('scenesCount').textContent = analysis.scene_analysis.total_scenes;
    document.getElementById('illustrationReadiness').textContent = analysis.summary.illustration_readiness;
    document.getElementById('narrativeComplexity').textContent = analysis.summary.narrative_complexity;

    // Update statistics
    const stats = analysis.statistics;
    document.getElementById('wordCount').textContent = stats.word_count.toLocaleString();
    document.getElementById('emotionalDensity').textContent = stats.emotional_density;
    document.getElementById('paragraphCount').textContent = stats.paragraph_count;
    document.getElementById('avgSentenceLength').textContent = stats.average_sentence_length;

    // Populate emotional moments
    populateEmotionalMoments(analysis.emotional_analysis.moments);

    // Populate scenes
    populateScenes(analysis.scene_analysis.scenes);

    // Populate narrative structure
    populateNarrativeStructure(analysis.narrative_analysis);

    // Populate illustration potential
    populateIllustrationMoments(analysis.illustration_potential.top_moments);

    // Store analysis data for export
    window.currentAnalysisData = analysis;
}

function populateEmotionalMoments(moments) {
    const container = document.getElementById('emotionalMomentsList');
    container.innerHTML = '';

    moments.forEach((moment, index) => {
        const momentCard = document.createElement('div');
        momentCard.className = 'card mb-3 border-left-primary';
        momentCard.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">Moment ${index + 1}</h6>
                    <div>
                        <span class="badge bg-primary">${moment.intensity_score.toFixed(2)}</span>
                        <span class="badge bg-info">${moment.visual_potential.toFixed(2)}</span>
                    </div>
                </div>
                <p class="card-text"><em>"${moment.text_excerpt}"</em></p>
                <div class="mb-2">
                    ${moment.emotional_tones.map(tone => `<span class="badge bg-secondary me-1">${tone}</span>`).join('')}
                </div>
                <small class="text-muted">${moment.context}</small>
            </div>
        `;
        container.appendChild(momentCard);
    });
}

function populateScenes(scenes) {
    const container = document.getElementById('scenesList');
    container.innerHTML = '';

    scenes.forEach((scene, index) => {
        const sceneCard = document.createElement('div');
        sceneCard.className = 'card mb-3';
        sceneCard.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">Scene ${index + 1}: ${scene.scene_type}</h6>
                    <span class="badge bg-info">${scene.word_count} words</span>
                </div>
                <p class="card-text">${scene.text_preview}</p>
                <div class="row small text-muted">
                    <div class="col-md-6">
                        <strong>Location:</strong> ${scene.location || 'Not specified'}<br>
                        <strong>Time:</strong> ${scene.time_context || 'Not specified'}
                    </div>
                    <div class="col-md-6">
                        <strong>Characters:</strong> ${scene.primary_characters.length > 0 ? scene.primary_characters.join(', ') : 'None identified'}<br>
                        <strong>Tone:</strong> ${scene.emotional_tone || 'Neutral'}
                    </div>
                </div>
            </div>
        `;
        container.appendChild(sceneCard);
    });
}

function populateNarrativeStructure(narrative) {
    // Tension Points
    const tensionContainer = document.getElementById('tensionPointsList');
    tensionContainer.innerHTML = '';

    narrative.tension_points.forEach((point, index) => {
        const pointDiv = document.createElement('div');
        pointDiv.className = 'mb-3 p-3 border-left border-warning';
        pointDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <strong>Point ${index + 1}</strong>
                <span class="badge bg-warning text-dark">${point.intensity.toFixed(2)}</span>
            </div>
            <p class="mb-1">${point.description}</p>
            <small class="text-muted">Type: ${point.tension_type}</small>
        `;
        tensionContainer.appendChild(pointDiv);
    });

    // Character Arcs
    const characterContainer = document.getElementById('characterArcsList');
    characterContainer.innerHTML = '';

    narrative.character_arcs.forEach(arc => {
        const arcDiv = document.createElement('div');
        arcDiv.className = 'mb-3 p-3 border-left border-success';
        arcDiv.innerHTML = `
            <strong>${arc.character_name}</strong>
            <p class="mb-1">${arc.arc_type} - ${arc.development_stage}</p>
            <small class="text-muted">Key moments: ${arc.key_moments.join(', ')}</small>
        `;
        characterContainer.appendChild(arcDiv);
    });

    // Themes
    const themesContainer = document.getElementById('themesList');
    themesContainer.innerHTML = narrative.themes.map(theme =>
        `<span class="badge bg-primary me-1 mb-1">${theme}</span>`
    ).join('');
}

function populateIllustrationMoments(moments) {
    const container = document.getElementById('illustrationMomentsList');
    container.innerHTML = '';

    moments.forEach((moment, index) => {
        const momentCard = document.createElement('div');
        momentCard.className = 'card mb-3 border-left-success';
        momentCard.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">Opportunity ${index + 1}</h6>
                    <div>
                        <span class="badge bg-success">${moment.visual_potential.toFixed(2)}</span>
                        <span class="badge bg-primary">${moment.intensity_score.toFixed(2)}</span>
                    </div>
                </div>
                <p class="card-text"><em>"${moment.text_excerpt}"</em></p>
                <p class="small text-muted">${moment.illustration_description}</p>
                <div>
                    ${moment.emotional_tones.map(tone => `<span class="badge bg-secondary me-1">${tone}</span>`).join('')}
                </div>
            </div>
        `;
        container.appendChild(momentCard);
    });
}

function exportAnalysis() {
    if (!window.currentAnalysisData) {
        showError('No analysis data available to export');
        return;
    }

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.currentAnalysisData, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", `chapter_analysis_${Date.now()}.json`);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();

    showSuccess('Analysis data exported successfully!');
}

async function deleteChapter(button) {
    const chapterId = button.closest('.chapter-card').getAttribute('data-chapter-id');
    const chapterTitle = button.closest('.chapter-card').querySelector('.chapter-title').textContent;

    if (!confirm(`Delete chapter "${chapterTitle}"? This action cannot be undone.`)) {
        return;
    }

    try {
        showLoadingOverlay('Deleting chapter...');

        const response = await fetch(`/api/chapters/${chapterId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete chapter');
        }

        hideLoadingOverlay();
        showSuccess('Chapter deleted successfully');
        loadManuscriptDetails(); // Reload to update

    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to delete chapter: ' + error.message);
    }
}

function deleteChapterFromDropdown(link) {
    const button = link.closest('.chapter-card').querySelector('.dropdown-toggle');
    deleteChapter(button);
}

function editManuscript() {
    window.location.href = `/manuscript/${currentManuscriptId}/edit`;
}

function configureStyle() {
    window.location.href = `/manuscript/${currentManuscriptId}/style`;
}

async function checkProcessingStatus() {
    try {
        const response = await fetch(`/api/process/status/${currentManuscriptId}`);
        if (response.ok) {
            const statusData = await response.json();

            if (statusData.active_session) {
                activeSession = statusData.active_session;
                updateProcessButton(true);
            } else {
                activeSession = null;
                updateProcessButton(false);
            }
        }
    } catch (error) {
        console.error('Error checking processing status:', error);
        updateProcessButton(false);
    }
}

function updateProcessButton(hasActiveSession) {
    const btn = document.getElementById('processBtn');
    const icon = document.getElementById('processIcon');
    const text = document.getElementById('processBtnText');

    if (hasActiveSession) {
        btn.className = 'btn btn-success';
        icon.className = 'bi bi-play-circle me-2';
        text.textContent = 'Resume Processing';

        // Add session status indicator
        const statusText = activeSession.status ? activeSession.status.status : 'in progress';
        const badge = document.createElement('small');
        badge.className = 'badge bg-light text-success ms-2';
        badge.textContent = statusText;

        // Remove existing badge if present
        const existingBadge = btn.querySelector('.badge');
        if (existingBadge) {
            existingBadge.remove();
        }

        btn.appendChild(badge);
    } else {
        btn.className = 'btn btn-primary';
        icon.className = 'bi bi-magic me-2';
        text.textContent = 'Generate Illustrations';

        // Remove status badge if present
        const existingBadge = btn.querySelector('.badge');
        if (existingBadge) {
            existingBadge.remove();
        }
    }
}

function processManuscript() {
    if (activeSession) {
        // Redirect to processing page with session ID
        window.location.href = `/manuscript/${currentManuscriptId}/process?session_id=${activeSession.session_id}`;
    } else {
        // Start new processing
        window.location.href = `/manuscript/${currentManuscriptId}/process`;
    }
}

function exportManuscript() {
    // Show export format modal
    showExportModal();
}

function showExportModal() {
    const modalHtml = `
        <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exportModalLabel">
                            <i class="bi bi-download me-2"></i>Export Manuscript
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Choose the format for exporting your manuscript:</p>

                        <div class="list-group">
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="radio" name="exportFormat" value="pdf" checked>
                                <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>
                                <strong>PDF</strong>
                                <small class="text-muted d-block">Professional document format, ideal for sharing and printing</small>
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="radio" name="exportFormat" value="docx">
                                <i class="bi bi-file-earmark-word me-2 text-primary"></i>
                                <strong>Word Document (.docx)</strong>
                                <small class="text-muted d-block">Editable format compatible with Microsoft Word</small>
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="radio" name="exportFormat" value="html">
                                <i class="bi bi-file-earmark-code me-2 text-warning"></i>
                                <strong>HTML</strong>
                                <small class="text-muted d-block">Web format with styling, can be opened in any browser</small>
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="radio" name="exportFormat" value="json">
                                <i class="bi bi-file-earmark-text me-2 text-info"></i>
                                <strong>JSON</strong>
                                <small class="text-muted d-block">Raw data format for technical use or backup</small>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="startExport()" id="exportBtn">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('exportModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

async function startExport() {
    const selectedFormat = document.querySelector('input[name="exportFormat"]:checked');
    if (!selectedFormat) {
        showError('Please select an export format');
        return;
    }

    const format = selectedFormat.value;
    const exportBtn = document.getElementById('exportBtn');
    const originalText = exportBtn.innerHTML;

    try {
        // Show loading state
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exporting...';

        // Call export API
        const response = await fetch(`/api/manuscripts/${currentManuscriptId}/export?export_format=${format}`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Export failed');
        }

        const result = await response.json();

        if (result.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
            modal.hide();

            // Show success message with download info
            showExportSuccessModal(result);
        } else {
            throw new Error('Export failed');
        }

    } catch (error) {
        showError(`Export failed: ${error.message}`);
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;
    }
}

function showExportSuccessModal(result) {
    const successModalHtml = `
        <div class="modal fade" id="exportSuccessModal" tabindex="-1" aria-labelledby="exportSuccessModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="exportSuccessModalLabel">
                            <i class="bi bi-check-circle me-2"></i>Export Successful
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <strong>Export completed successfully!</strong>
                        </div>

                        <div class="row">
                            <div class="col-sm-4"><strong>Format:</strong></div>
                            <div class="col-sm-8">${result.export_format}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Filename:</strong></div>
                            <div class="col-sm-8">${result.filename}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>File Size:</strong></div>
                            <div class="col-sm-8">${formatFileSize(result.file_size)}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Exported:</strong></div>
                            <div class="col-sm-8">${formatDateTime(new Date(result.exported_at))}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="${result.download_url}" class="btn btn-primary" download="${result.filename}">
                            <i class="bi bi-download me-1"></i>Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('exportSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', successModalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('exportSuccessModal'));
    modal.show();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDateTime(date) {
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

async function deleteManuscript() {
    if (!confirm('Delete this entire manuscript? This action cannot be undone.')) {
        return;
    }

    try {
        showLoadingOverlay('Deleting manuscript...');

        const response = await fetch(`/api/manuscripts/${currentManuscriptId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete manuscript');
        }

        hideLoadingOverlay();
        showSuccess('Manuscript deleted successfully');
        setTimeout(() => {
            window.location.href = '/';
        }, 1500);

    } catch (error) {
        hideLoadingOverlay();
        showError('Failed to delete manuscript: ' + error.message);
    }
}
</script>
{% endblock %}
