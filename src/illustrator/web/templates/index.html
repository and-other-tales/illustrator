{% extends "base.html" %}

{% block title %}Dashboard - Manuscript Illustrator{% endblock %}

{% block page_icon %}<i class="bi bi-house me-2"></i>{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="/manuscript/new" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> New Manuscript
    </a>
    <button type="button" class="btn btn-outline-primary" onclick="refreshDashboard()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row mb-5 g-4">
    <div class="col-lg-10 offset-lg-1 col-xl-8 offset-xl-2">
        <div class="row g-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card modern-stats-card bg-primary text-white h-100 bounce-in">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <div class="stats-icon me-3">
                                <i class="material-icons-outlined fs-2">auto_stories</i>
                            </div>
                            <h5 class="card-title mb-0 opacity-90">Manuscripts</h5>
                        </div>
                        <h1 class="mb-1 fw-bold" id="totalManuscripts">
                            <span class="counter" data-target="0">0</span>
                        </h1>
                        <small class="opacity-75">
                            <i class="bi bi-trend-up me-1"></i>
                            <span id="manuscriptsTrend">+0% from last month</span>
                        </small>
                    </div>
                </div>
                <div class="stats-wave"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card stats-card modern-stats-card bg-success text-white h-100 bounce-in" style="animation-delay: 0.1s;">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <div class="stats-icon me-3">
                                <i class="material-icons-outlined fs-2">description</i>
                            </div>
                            <h5 class="card-title mb-0 opacity-90">Chapters</h5>
                        </div>
                        <h1 class="mb-1 fw-bold" id="totalChapters">
                            <span class="counter" data-target="0">0</span>
                        </h1>
                        <small class="opacity-75">
                            <i class="bi bi-book me-1"></i>
                            <span id="chaptersTrend">Across all manuscripts</span>
                        </small>
                    </div>
                </div>
                <div class="stats-wave"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card stats-card modern-stats-card bg-warning text-white h-100 bounce-in" style="animation-delay: 0.2s;">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <div class="stats-icon me-3">
                                <i class="material-icons-outlined fs-2">image</i>
                            </div>
                            <h5 class="card-title mb-0 opacity-90">Illustrations</h5>
                        </div>
                        <h1 class="mb-1 fw-bold" id="totalImages">
                            <span class="counter" data-target="0">0</span>
                        </h1>
                        <small class="opacity-75">
                            <i class="bi bi-palette me-1"></i>
                            <span id="imagesTrend">Generated with AI</span>
                        </small>
                    </div>
                </div>
                <div class="stats-wave"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card stats-card modern-stats-card processing-card text-white h-100 bounce-in" style="animation-delay: 0.3s;">
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <div class="stats-icon me-3">
                                <i class="material-icons-outlined fs-2 processing-icon">settings</i>
                            </div>
                            <h5 class="card-title mb-0 opacity-90">Processing</h5>
                        </div>
                        <h1 class="mb-1 fw-bold" id="processingCount">
                            <span class="counter" data-target="0">0</span>
                        </h1>
                        <small class="opacity-75">
                            <i class="bi bi-activity me-1"></i>
                            <span id="processingTrend">Active tasks</span>
                        </small>
                    </div>
                </div>
                <div class="stats-wave processing-wave"></div>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Recent Manuscripts -->
<div class="row recent-manuscripts-section">
    <div class="col-lg-10 offset-lg-1 col-xl-8 offset-xl-2">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0 fw-bold">
                    <i class="bi bi-clock-history me-2"></i>Recent Manuscripts
                </h3>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="setManuscriptView('grid')" id="gridViewBtn">
                        <i class="bi bi-grid"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary active" onclick="setManuscriptView('list')" id="listViewBtn">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div id="manuscriptsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading manuscripts...</span>
                    </div>
                    <div class="mt-2">Loading manuscripts...</div>
                </div>

                <!-- Empty State -->
                <div id="manuscriptsEmpty" class="text-center py-5 d-none">
                    <i class="bi bi-book text-muted" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3">No Manuscripts Yet</h4>
                    <p class="text-muted">Create your first manuscript to get started with AI-powered illustrations.</p>
                    <a href="/manuscript/new" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create First Manuscript
                    </a>
                </div>

                <!-- List View -->
                <div id="manuscriptsList" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Chapters</th>
                                    <th>Images</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="manuscriptsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Grid View -->
                <div id="manuscriptsGrid" class="row d-none">
                    <!-- Dynamic content -->
                </div>

                <!-- Pagination -->
                <nav aria-label="Manuscripts pagination" id="manuscriptsPagination" class="d-none">
                    <ul class="pagination justify-content-center">
                        <!-- Dynamic pagination -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Modal -->
<div class="modal fade" id="quickActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <a href="/manuscript/new" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create New Manuscript
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="loadSavedManuscripts()">
                        <i class="bi bi-folder-open"></i> Load Saved Manuscript
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="importManuscript()">
                        <i class="bi bi-upload"></i> Import Manuscript File
                    </button>
                    <hr>
                    <button type="button" class="btn btn-outline-info" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#apiKeysModal">
                        <i class="bi bi-key"></i> Configure API Keys
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();

    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
});

async function loadDashboardData() {
    try {
        showLoading('manuscriptsLoading');

        const response = await fetch('/api/manuscripts/stats');
        const data = await response.json();

        // Animate counter updates
        animateCounter('totalManuscripts', data.total_manuscripts || 0);
        animateCounter('totalChapters', data.total_chapters || 0);
        animateCounter('totalImages', data.total_images || 0);
        animateCounter('processingCount', data.processing_count || 0);

        // Load manuscripts
        if (data.recent_manuscripts && data.recent_manuscripts.length > 0) {
            renderManuscripts(data.recent_manuscripts);
        } else {
            showEmpty('manuscriptsEmpty');
        }

    } catch (error) {
        console.error('Error loading dashboard data:', error);

        // Show skeleton loading on error for better UX
        showSkeletonLoading();
        setTimeout(() => {
            hideSkeletonLoading();
            showError('Failed to load dashboard data');
        }, 2000);
    }
}

function animateCounter(elementId, target) {
    const element = document.getElementById(elementId);
    const counter = element.querySelector('.counter');

    if (!counter) return;

    const startValue = parseInt(counter.textContent) || 0;
    const increment = Math.ceil((target - startValue) / 30);
    const duration = 1500;
    const stepTime = duration / Math.abs(target - startValue);

    let currentValue = startValue;

    const timer = setInterval(() => {
        currentValue += increment;

        if ((increment > 0 && currentValue >= target) || (increment < 0 && currentValue <= target)) {
            currentValue = target;
            clearInterval(timer);
        }

        counter.textContent = currentValue;
        counter.style.transform = 'scale(1.1)';

        setTimeout(() => {
            counter.style.transform = 'scale(1)';
        }, 100);

    }, stepTime);
}

function showSkeletonLoading() {
    // Add skeleton loading to stats cards
    const statsCards = document.querySelectorAll('.modern-stats-card');
    statsCards.forEach(card => {
        const counter = card.querySelector('.counter');
        if (counter) {
            counter.classList.add('skeleton', 'skeleton-text');
            counter.style.width = '60px';
            counter.style.height = '2rem';
        }
    });
}

function hideSkeletonLoading() {
    const statsCards = document.querySelectorAll('.modern-stats-card');
    statsCards.forEach(card => {
        const counter = card.querySelector('.counter');
        if (counter) {
            counter.classList.remove('skeleton', 'skeleton-text');
            counter.style.width = 'auto';
            counter.style.height = 'auto';
        }
    });
}

function renderManuscripts(manuscripts) {
    const isGridView = document.getElementById('gridViewBtn').classList.contains('active');

    if (isGridView) {
        renderManuscriptsGrid(manuscripts);
    } else {
        renderManuscriptsList(manuscripts);
    }

    hideLoading();
}

function renderManuscriptsList(manuscripts) {
    const tbody = document.getElementById('manuscriptsTableBody');
    tbody.innerHTML = manuscripts.map(manuscript => `
        <tr>
            <td>
                <div class="fw-bold">${escapeHtml(manuscript.metadata.title)}</div>
                <small class="text-muted">${escapeHtml(manuscript.metadata.genre || 'No genre')}</small>
            </td>
            <td>${escapeHtml(manuscript.metadata.author || 'Anonymous')}</td>
            <td>${manuscript.chapters.length}</td>
            <td>${manuscript.total_images}</td>
            <td>
                <span class="badge ${getStatusBadgeClass(manuscript.processing_status)}">
                    ${manuscript.processing_status}
                </span>
            </td>
            <td>${formatDate(manuscript.updated_at)}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="/manuscript/${manuscript.id}" class="btn btn-outline-primary" title="View">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="/manuscript/${manuscript.id}/edit" class="btn btn-outline-secondary" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="/manuscript/${manuscript.id}/gallery" class="btn btn-outline-success" title="Gallery">
                        <i class="bi bi-images"></i>
                    </a>
                    <button onclick="deleteManuscriptFromDashboard('${manuscript.id}')" class="btn btn-outline-danger" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    document.getElementById('manuscriptsList').classList.remove('d-none');
    document.getElementById('manuscriptsGrid').classList.add('d-none');
}

function renderManuscriptsGrid(manuscripts) {
    const grid = document.getElementById('manuscriptsGrid');
    grid.innerHTML = manuscripts.map(manuscript => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">${escapeHtml(manuscript.metadata.title)}</h5>
                    <p class="card-text text-muted">${escapeHtml(manuscript.metadata.author || 'Anonymous')}</p>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">${manuscript.chapters.length} chapters</small>
                        <span class="badge ${getStatusBadgeClass(manuscript.processing_status)}">
                            ${manuscript.processing_status}
                        </span>
                    </div>
                    ${manuscript.total_images > 0 ? `<small class="text-success">${manuscript.total_images} images generated</small>` : ''}
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100" role="group">
                        <a href="/manuscript/${manuscript.id}" class="btn btn-primary btn-sm">
                            <i class="bi bi-eye"></i> View
                        </a>
                        <a href="/manuscript/${manuscript.id}/gallery" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-images"></i> Gallery
                        </a>
                        <button onclick="deleteManuscriptFromDashboard('${manuscript.id}')" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('manuscriptsGrid').classList.remove('d-none');
    document.getElementById('manuscriptsList').classList.add('d-none');
}

function setManuscriptView(viewType) {
    const gridBtn = document.getElementById('gridViewBtn');
    const listBtn = document.getElementById('listViewBtn');

    if (viewType === 'grid') {
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
    } else {
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
    }

    // Re-render if we have data
    const tbody = document.getElementById('manuscriptsTableBody');
    if (tbody.children.length > 0) {
        // Re-fetch and render with new view
        loadDashboardData();
    }
}

function refreshDashboard() {
    loadDashboardData();
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'completed': return 'bg-success';
        case 'processing': return 'bg-warning';
        case 'error': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

async function deleteManuscriptFromDashboard(manuscriptId) {
    if (!confirm('Are you sure you want to delete this manuscript? This action cannot be undone and will also delete all generated images.')) {
        return;
    }

    try {
        const response = await fetch(`/api/manuscripts/${manuscriptId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // Refresh the dashboard to show updated list
            loadDashboardData();
        } else {
            const error = await response.json();
            alert('Error deleting manuscript: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}
</script>
{% endblock %}